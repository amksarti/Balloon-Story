<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Exosphere Test - Balloon Story</title>
    <style>
        body {
            margin: 0; padding: 0; overflow: hidden;
            background: #050505; transition: background 4s ease;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            touch-action: none; width: 100vw; height: 100vh; position: fixed; 
        }
        canvas { display: block; position: absolute; top: 0; left: 0; }
        
        #ui {
            position: absolute; top: 8%; left: 0; width: 100%;
            text-align: center; pointer-events: none; color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3); z-index: 10;
        }
        #title { font-size: 1rem; letter-spacing: 4px; font-weight: 700; text-transform: uppercase; color: #FFD700; }
        #score-container { font-weight: 900; line-height: 1; margin-top: 5px;}
        #current-score { font-size: 4.5rem; display: block; }
        #best-score { font-size: 1.1rem; opacity: 0.8; margin-top: 5px; display: block; }
        
        #menu-btn {
            position: absolute; top: 5%; left: 5%;
            background: rgba(255,255,255,0.2); color: white;
            padding: 10px 18px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.4);
            font-size: 0.85rem; font-weight: bold; text-transform: uppercase;
            pointer-events: auto; display: none; z-index: 25;
            backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
        }

        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.6); color: white; z-index: 30; text-align: center;
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
        }
        .btn {
            background: #4A90E2; color: white; padding: 18px 60px; border-radius: 40px;
            font-weight: 800; text-transform: uppercase; letter-spacing: 2px;
            margin-top: 25px; pointer-events: auto; border: none; font-size: 1.3rem;
        }

        #milestone-pop {
            position: absolute; top: 30%; width: 100%; text-align: center;
            color: #FFD700; font-weight: 900; font-size: 2rem; text-transform: uppercase;
            letter-spacing: 6px; opacity: 0; transition: opacity 0.6s; z-index: 15;
            pointer-events: none;
        }
        .toggle-box {
            margin-top: 25px; background: rgba(255,255,255,0.15);
            padding: 12px 25px; border-radius: 25px; pointer-events: auto;
            font-size: 1rem; letter-spacing: 1px; text-transform: uppercase;
        }
        input[type="checkbox"] { transform: scale(1.6); margin-right: 15px; vertical-align: middle; }
    </style>
</head>
<body>
    <div id="ui">
        <div id="title">Exosphere (Physics Test)</div>
        <div id="score-container">
            <span id="current-score">0</span>
            <span id="best-score">Best: 0</span>
        </div>
    </div>

    <button id="menu-btn" onclick="endGameManually()">Menu</button>

    <div id="start-overlay" class="overlay">
        <h1 style="letter-spacing: 10px; font-size: 2.2rem; margin: 0; font-weight: 900;">SPACE TEST</h1>
        <p style="opacity: 0.7; margin-top: 8px; font-weight: 500;">Testing 0.12 Gravity & Solar Flares</p>
        <div class="toggle-box">
            <label><input type="checkbox" id="god-toggle" checked> Infinite Bounce</label>
        </div>
        <button class="btn" onclick="startGame()">Start Test</button>
    </div>

    <div id="gameover-overlay" class="overlay" style="display: none;">
        <h1 style="letter-spacing: 6px; color: #FFFFFF; margin-bottom: 0; font-weight: 900;">TEST ENDED</h1>
        <p id="final-stats" style="margin: 20px 0; font-size: 1.1rem; opacity: 0.9;"></p>
        <button class="btn" onclick="resetToStart()">Play Again</button>
    </div>

    <div id="milestone-pop">SPACE REACHED</div>

    <canvas id="gameCanvas"></canvas>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreEl = document.getElementById('current-score');
    const bestEl = document.getElementById('best-score');
    const titleEl = document.getElementById('title');
    const milestonePop = document.getElementById('milestone-pop');
    const godToggle = document.getElementById('god-toggle');
    const menuBtn = document.getElementById('menu-btn');

    // --- TEST PHYSICS: LOCKED TO EXOSPHERE ---
    const TEST_GRAVITY = 0.12; 
    const TAP_POWER = -8.8;

    let width, height, balloon, score, gameState, currentGroundY;
    let backdrops = [], clouds = [], stars = [], obstacles = [], decor = [], shieldItem = null;
    let hasShield = false, birdSpawnTimer = 0, shieldSpawnTimer = 0, shakeTimer = 0;
    let wind = { force: 0, timer: 0, maxTimer: 110, visualX: 0, nextAt: 10, active: false };
    let highScore = localStorage.getItem('balloonHighScore') || 0;

    function init() {
        width = window.innerWidth; height = window.innerHeight;
        canvas.width = width; canvas.height = height;
        currentGroundY = height * 1.5; // Push ground far away for space feel
        gameState = 'START';
        
        balloon = { x: width/2, y: height/2, radius: Math.min(width, height)*0.08, vx: 0, vy: 0, color: '#FF5F5F' };
        backdrops = []; clouds = []; stars = []; obstacles = []; decor = []; shieldItem = null;
        score = 0; hasShield = false; shakeTimer = 0; 
        
        wind = { force: 0, timer: 0, maxTimer: 110, visualX: 0, nextAt: 8 + Math.floor(Math.random()*5), active: false };
        
        document.body.style.background = "#050505";
        scoreEl.innerText = "0";
        bestEl.innerText = `Best: ${highScore}`;
        menuBtn.style.display = 'none';

        for(let i=0; i<80; i++) stars.push({x: Math.random()*width, y: Math.random()*height, s: Math.random()*2});
    }

    function startGame() {
        gameState = 'PLAYING';
        document.getElementById('start-overlay').style.display = 'none';
        menuBtn.style.display = 'block';
    }

    function resetToStart() {
        document.getElementById('gameover-overlay').style.display = 'none';
        init();
        document.getElementById('start-overlay').style.display = 'flex';
    }

    function triggerMilestone(text) {
        milestonePop.innerText = text;
        milestonePop.style.opacity = 1;
        setTimeout(() => milestonePop.style.opacity = 0, 2500);
    }

    function gameOver() {
        if (godToggle.checked) return;
        gameState = 'GAMEOVER';
        menuBtn.style.display = 'none';
        document.getElementById('gameover-overlay').style.display = 'flex';
        document.getElementById('final-stats').innerText = `Space Score: ${score}`;
    }

    function endGameManually() {
        gameState = 'GAMEOVER';
        menuBtn.style.display = 'none';
        document.getElementById('gameover-overlay').style.display = 'flex';
        document.getElementById('final-stats').innerText = `Score: ${score}`;
    }

    function spawnCloud() {
        clouds.push({ x: width + 200, y: Math.random() * (height * 0.8), size: 10 + Math.random() * 20, speed: 0.1 + Math.random() * 0.2, alpha: 0.05 + Math.random() * 0.1 });
    }

    function spawnObstacle() {
        const side = Math.random() > 0.5 ? -50 : width + 50;
        let speed = (side < 0 ? 1 : -1) * (3.0 + (score/30));
        obstacles.push({ x: side, y: 100 + Math.random()*(height-200), vx: speed, type: "satellite", wing: 0 });
    }

    function spawnShield() {
        if (hasShield || shieldItem) return;
        shieldItem = { x: 50 + Math.random() * (width - 100), y: -50, vy: 1.5 };
    }

    window.addEventListener('touchstart', (e) => {
        if (gameState !== 'PLAYING') return;
        const touch = e.touches[0];
        const dist = Math.sqrt((touch.clientX - balloon.x)**2 + (touch.clientY - balloon.y)**2);
        
        if (dist < balloon.radius + 85) {
            balloon.vy = TAP_POWER; 
            balloon.vx = (balloon.x - touch.clientX) * 0.5;
            score++;
            scoreEl.innerText = score;
            
            if (score % 50 === 0) triggerMilestone("DEEP ORBIT: " + score);

            // WIND ENGINE (Solar Flares)
            if (score >= wind.nextAt && !wind.active) {
                wind.active = true;
                wind.force = (Math.random() > 0.5 ? 1 : -1) * 3.5;
                wind.timer = 110; 
                wind.maxTimer = wind.timer;
                wind.nextAt = score + 8 + Math.floor(Math.random()*8);
                shakeTimer = 20; 
            }

            if (score > highScore) {
                highScore = score;
                localStorage.setItem('balloonHighScore', highScore);
                bestEl.innerText = `Best: ${highScore}`;
            }
        }
    }, { passive: false });

    function update() {
        if (gameState === 'PLAYING') {
            clouds.forEach(c => c.x -= c.speed);
            
            if (wind.timer > 0) {
                balloon.vx += wind.force * 0.05; wind.timer--; wind.visualX += wind.force * 22;
                if (wind.timer <= 0) wind.active = false;
            }

            balloon.vy += TEST_GRAVITY; balloon.y += balloon.vy; balloon.x += balloon.vx; balloon.vx *= 0.98;

            if (balloon.x < balloon.radius) { balloon.x = balloon.radius; balloon.vx = Math.abs(balloon.vx) * 0.5 + 1.2; }
            if (balloon.x > width - balloon.radius) { balloon.x = width - balloon.radius; balloon.vx = -(Math.abs(balloon.vx) * 0.5 + 1.2); }

            birdSpawnTimer++;
            if (birdSpawnTimer > 40) { spawnObstacle(); birdSpawnTimer = 0; }

            shieldSpawnTimer++;
            if (shieldSpawnTimer > 300) { spawnShield(); shieldSpawnTimer = 0; }

            obstacles.forEach((o, i) => {
                o.x += o.vx;
                let d = Math.sqrt((balloon.x-o.x)**2 + (balloon.y-o.y)**2);
                if (d < balloon.radius + 15) { 
                    if (hasShield) { hasShield = false; obstacles.splice(i, 1); } else { gameOver(); }
                }
                if (o.x < -250 || o.x > width + 250) obstacles.splice(i, 1);
            });

            if (shieldItem) {
                shieldItem.y += 1.5;
                let d = Math.sqrt((balloon.x-shieldItem.x)**2 + (balloon.y-shieldItem.y)**2);
                if (d < balloon.radius + 20) { hasShield = true; shieldItem = null; }
                else if (shieldItem.y > height) shieldItem = null;
            }

            // Always safe bottom for the "Love of the Bounce"
            if (balloon.y + balloon.radius > height * 0.95) {
                balloon.y = height * 0.95 - balloon.radius; balloon.vy = -Math.abs(balloon.vy) * 0.4;
            }
            if (shakeTimer > 0) shakeTimer--;
        }
        draw();
        requestAnimationFrame(update);
    }

    function draw() {
        ctx.save();
        if (shakeTimer > 0) ctx.translate(Math.random()*12-6, Math.random()*12-6);

        ctx.clearRect(0, 0, width, height);
        
        // Stars
        ctx.fillStyle = "white"; 
        stars.forEach(s => { ctx.globalAlpha = 0.3 + Math.random()*0.7; ctx.fillRect(s.x, s.y, s.s, s.s); }); 
        ctx.globalAlpha = 1.0; 

        // Rare Space Clouds (Gas clouds)
        clouds.forEach(c => { ctx.fillStyle = `rgba(100, 50, 255, ${c.alpha})`; ctx.beginPath(); ctx.arc(c.x, c.y, c.size, 0, Math.PI*2); ctx.fill(); });

        // --- SOLAR FLARE VISUALS ---
        if (wind.timer > 0) {
            let opacity = Math.min(0.8, wind.timer / 30); if (wind.timer > (wind.maxTimer - 30)) opacity = (wind.maxTimer - wind.timer) / 30;
            ctx.globalAlpha = opacity; 
            ctx.strokeStyle = "rgba(255, 60, 0, 0.9)"; ctx.lineWidth = 12;
            ctx.shadowBlur = 30; ctx.shadowColor = "#FF0000";
            for(let i=0; i<8; i++) {
                let y = (height * 0.1) + i * (height * 0.1);
                let xStart = (wind.visualX + (i * 150)) % (width + 300) - 150;
                ctx.beginPath(); ctx.moveTo(xStart, y); ctx.lineTo(xStart + (wind.force > 0 ? 150 : -150), y); ctx.stroke();
            }
            ctx.shadowBlur = 0; ctx.globalAlpha = 1.0;
        }

        // Earth Curve far below
        ctx.strokeStyle = "rgba(0, 162, 255, 0.8)"; ctx.lineWidth = 20;
        ctx.beginPath(); ctx.arc(width/2, height * 5, height * 4.1, 0, Math.PI*2); ctx.stroke();

        // Satellites
        obstacles.forEach(o => { 
            ctx.lineWidth = 4; ctx.strokeStyle = "#00F2FF"; 
            ctx.fillStyle = "#888"; ctx.fillRect(o.x-15, o.y-5, 30, 10);
            ctx.fillStyle = "#00F2FF"; ctx.fillRect(o.x-25, o.y-8, 10, 16); ctx.fillRect(o.x+15, o.y-8, 10, 16);
        });

        // Shield Item
        if (shieldItem) {
            ctx.fillStyle = "#00FF7F"; ctx.shadowBlur = 15; ctx.shadowColor = "#00FF7F";
            ctx.beginPath(); ctx.arc(shieldItem.x, shieldItem.y, 15, 0, Math.PI*2); ctx.fill();
            ctx.shadowBlur = 0;
        }

        // Balloon & String
        ctx.beginPath(); ctx.moveTo(balloon.x, balloon.y + balloon.radius); ctx.lineTo(balloon.x - (balloon.vx * 4), balloon.y + balloon.radius + 40); ctx.strokeStyle = "rgba(255, 255, 255, 0.4)"; ctx.lineWidth = 1.5; ctx.stroke();
        ctx.shadowBlur = 25; ctx.shadowColor = "white";
        ctx.beginPath(); ctx.arc(balloon.x, balloon.y, balloon.radius, 0, Math.PI * 2); ctx.fillStyle = balloon.color; ctx.fill(); ctx.shadowBlur = 0;

        if (hasShield) {
            ctx.strokeStyle = "#00FF7F"; ctx.lineWidth = 6;
            ctx.beginPath(); ctx.arc(balloon.x, balloon.y, balloon.radius + 12, 0, Math.PI*2); ctx.stroke();
        }

        ctx.restore();
    }

    init(); update();
</script>
</body>
</html>
